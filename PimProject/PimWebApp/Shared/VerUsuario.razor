@using PimWebApp.Data
@using PimWebApp.Interfaz
@using System.Threading
@inject IUsuarioServices UsuariosServicio
@inject IJSRuntime JsRuntime
@inject NavigationManager navigationManager;

<div class="blazor-modal blazor-modal-content @cssClass">
    <h3 class="NuevoU blazor-modal-header"></h3>

    <EditForm Model="@usuario">
        <table class="NuevoU blazor-modal-body">

            <tr>
                <td>URL: </td>
                <td><input type="text" @bind="usuario.Direccion" /></td>
            </tr>

            <tr>
                <td>Nombre de Usuario: </td>
                <td><input type="text" @bind="usuario.NombreUsuario" /></td>
            </tr>

            <tr>
                <td>Correo: </td>
                <td><input type="text" @bind="usuario.Correo" /></td>
            </tr>

            <tr>
                <td>Contraseña: </td>
                <td><input type="text" @bind="usuario.Contraseña" /></td>
            </tr>

            <tr>
                <td>Nota: </td>
                <td><input type="text" @bind="usuario.Nota" /></td>
            </tr>
            <tr>
                <td>Categoria: </td>
                <td>
                    @if (categoria == null)
                    {
                    }
                    else
                    {
                        <select class="form-control " @bind="usuario.ID_Categoria">
                            @foreach (Categorias item in categoria)
                            {
                                <option value="@item.ID">@item.Nombre</option>
                            }
                        </select>
                    }
                </td>
            </tr>


        </table>
    </EditForm>
    <div class="blazor-modal-footer">
        @ModalFooter
        <table>
            <tr>
                <td colspan="2">
                    <input type="submit" class="btn btn-primary" value="Guardar" @onclick="Guardar" />
                    <input type="button" class="btn btn-danger" value="Cancelar" @onclick="Cancelar" />
                </td>
            </tr>
        </table>
    </div>
    <div clas="btn">
        <div class="btn_eliminar " @onclick="(() => Borrar(usuario.ID))"><img src="/imagenes/basura.png" class="btb" /></div>
    </div>

</div>

@code {

    [Parameter]
    public RenderFragment ModalBody { get; set; }

    [Parameter]
    public RenderFragment ModalFooter { get; set; }

    [Parameter]
    public bool IsOpened { get; set; }

    [Parameter]
    public Usuario usuario { get; set; }

    string cssClass => IsOpened ? "show" : "hide";

    protected async Task Guardar()
    {
        await UsuariosServicio.GuardarUsuario(usuario);
        IsOpened = false;
        navigationManager.NavigateTo("/password");
        F_5();
    }
    protected void Cancelar()
    {
        IsOpened = false;
        navigationManager.NavigateTo("/password");
    }

    protected async Task Borrar(int id)
    {
        bool confirmar = await JsRuntime.InvokeAsync<bool>("confirm", "¿Esta Seguro?");
        if (confirmar)
        {
            await UsuariosServicio.BorrarUsuario(id);
        }
        IsOpened = false;
        F_5();
    }

    protected void F_5()
    {
        var timer = new Timer(new TimerCallback(_ =>
        {
            navigationManager.NavigateTo(navigationManager.Uri, forceLoad: true);
        }), null, 200, 200);
    }

    private IEnumerable<Categorias> categoria;


    protected override async Task OnInitializedAsync()
    {
        try
        {
            categoria = await UsuariosServicio.ListarCategorias();
        }
        catch
        {
            throw;
        }
    }


}